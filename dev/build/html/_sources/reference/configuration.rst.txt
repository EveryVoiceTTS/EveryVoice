.. _configuration:

Configuration
=============

Each model has a statically typed configuration model. Each configuration has default settings that will be instantiated when the model is instantiated. To create a default preprocessing configuration for example you would:

.. code-block:: python

    from everyvoice.config.preprocessing_config import PreprocessingConfig

    preprocessing_config = PreprocessingConfig()

Static typing means that if someone accidentally enters an integer that the configuration expects should be a float or some other trivial typing difference, it is
corrected when the configuration is instantiated, and doesn't produce downstream runtime errors. It also means that intellisense is available in your code editor
when working with a configuration class.

.. _new-dataset:

New Dataset Wizard üßô‚Äç‚ôÄÔ∏è
--------------------------

This section of the documentation is meant for technical explanations and reference documentation - if you're just looking to get started, have a look at the :ref:`guides` section instead to learn about how the New Dataset Wizard üßô‚Äç‚ôÄÔ∏è can help you configure everything for your dataset.

Here is the reference documentation for the New Dataset Wizard üßô‚Äç‚ôÄÔ∏è

.. click:: everyvoice.cli:CLICK_APP
    :prog: everyvoice
    :nested: full
    :commands: new-dataset


Sharing Configurations
----------------------

The Text and Preprocessing configurations should only be defined once per dataset and shared between your models to ensure each model makes the same assumptions about your data.
To achieve that, each model configuration can also be defined as a path to a configuration file. So, a configuration for an :ref:`aligner` model that uses separately defined text and audio preprocessing configurations might look like this:

.. code-block:: yaml
    :caption: See highlighted lines with links to text and preprocessing configurations
    :emphasize-lines: 8, 9

    model:
        lstm_dim: 512
        conv_dim: 512
        ...
    training:
        batch_size: 32
        ...
    preprocessing: "./config/default/preprocessing.yaml"
    text: "./config/default/text_eng.yaml"


Serialization
-------------

By default configuration objects are serialized as dictionaries, which works as expected with integers, floats, lists, booleans, dicts etc. But there are some cases where you need to specify a Callable in your configuration. For example the :ref:`TextConfig` has a `cleaners` field that takes a list of Callables to apply in order to raw text.
By default, these functions turn raw text to lowercase, collapse whitespace, and normalize using Unicode NFC normalization. In Python, we could instantiate this by passing the callables directly like so:

.. code-block:: python
    :caption: You can instantiate configuration objects with callables in Python

    from everyvoice.config.text_config import TextConfig
    from everyvoice.utils import collapse_whitespace, lower, nfc_normalize

    text_config = TextConfig(cleaners=[lower, collapse_whitespace, nfc_normalize])

But, for yaml or json configuration, we need to serialize these functions. To do so, |project| will turn each callable into module dot-notation. That is,
your configuration will look like this in yaml:

.. code-block:: yaml
    :caption: Callables will be serialized using module dot-notation in yaml and json

    cleaners:
        - everyvoice.utils.lower
        - everyvoice.utils.collapse_whitespace
        - everyvoice.utils.nfc_normalize

This will then be de-serialized upon instantiation of your configuration.

Text Configuration
------------------

The TextConfig is where you define the symbol set for your data and any cleaners used to clean your raw text into the text needed
for your data. You can share the TextConfig with any models that need it and only need one text configuration per dataset (and possibly only per language).

.. note::
    Only the :ref:`aligner`, :ref:`feature_prediction`, and :ref:`e2e` models need text configuration. The :ref:`vocoder` is trained without text and does not need a TextConfig. For more information on this, see the :ref:`background` section.

.. _TextConfig:

TextConfig
**********

.. autopydantic_settings:: everyvoice.config.text_config.TextConfig
    :settings-show-json: False
    :settings-show-config-member: False
    :settings-show-config-summary: False
    :settings-show-validator-members: True
    :settings-show-validator-summary: True
    :field-list-validators: True

Symbols
*******

.. autopydantic_settings:: everyvoice.config.text_config.Symbols
    :settings-show-json: True
    :settings-show-config-member: False
    :settings-show-config-summary: False
    :settings-show-validator-members: True
    :settings-show-validator-summary: True
    :field-list-validators: True


Preprocessing Configuration
----------------------------
